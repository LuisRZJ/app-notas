<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estadísticas del Diario</title>
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#2563eb">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="./logo-app.png">
    <link rel="icon" type="image/png" href="./logo-app.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            overscroll-behavior-y: contain;
        }
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        ::-webkit-scrollbar-thumb {
            background: #94a3b8;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }
        .stat-card {
            background: linear-gradient(135deg, rgba(37, 99, 235, 0.08), rgba(37, 99, 235, 0.02));
            border-radius: 1.25rem;
            position: relative;
            overflow: hidden;
        }
        .stat-card::after {
            content: '';
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at top right, rgba(37, 99, 235, 0.12), transparent 55%);
            pointer-events: none;
        }
        .stat-card-content {
            position: relative;
            z-index: 10;
        }
        .stat-highlight {
            background: rgba(37, 99, 235, 0.12);
            border-radius: 9999px;
        }
        .detail-card {
            border-radius: 1.5rem;
            background: rgba(255, 255, 255, 0.85);
            border: 1px solid rgba(148, 163, 184, 0.35);
            box-shadow: 0 20px 36px rgba(15, 23, 42, 0.08);
        }
        #monthly-comparison-message,
        #notes-heatmap-message {
            min-height: 1.5rem;
        }
        #notes-heatmap-grid {
            min-height: 260px;
        }
        .heatmap-cell {
            border-radius: 0.75rem;
            padding: 0.75rem 0.5rem;
            text-align: center;
            transition: transform 0.15s ease, box-shadow 0.15s ease;
            background: rgba(148, 163, 184, 0.12);
        }
        .heatmap-cell:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 18px rgba(15, 23, 42, 0.08);
        }
        .heatmap-cell__date {
            display: block;
            font-size: 0.75rem;
            font-weight: 600;
            margin-bottom: 0.35rem;
        }
        .heatmap-cell__count {
            font-size: 0.85rem;
            font-weight: 700;
        }
        .heatmap-cell__empty {
            opacity: 0.55;
            font-weight: 500;
        }
        .heatmap-cell__blank {
            visibility: hidden;
            pointer-events: none;
        }
        .tag-pill {
            border-radius: 9999px;
            background: rgba(37, 99, 235, 0.08);
            color: #1d4ed8;
        }
        body[data-theme="dark"] {
            background-color: #0f172a;
            color: #f8fafc;
        }
        body[data-theme="dark"] .bg-white,
        body[data-theme="dark"] .bg-slate-50,
        body[data-theme="dark"] .bg-slate-100 {
            background-color: #1f2937 !important;
            color: #f8fafc;
        }
        body[data-theme="dark"] .bg-slate-200,
        body[data-theme="dark"] .bg-slate-300 {
            background-color: #334155 !important;
            color: #f8fafc !important;
        }
        body[data-theme="dark"] .text-slate-900,
        body[data-theme="dark"] .text-slate-800,
        body[data-theme="dark"] .text-slate-700 {
            color: #f1f5f9 !important;
        }
        body[data-theme="dark"] .text-slate-600 {
            color: #cbd5f5 !important;
        }
        body[data-theme="dark"] .text-slate-500,
        body[data-theme="dark"] .text-slate-400 {
            color: #94a3b8 !important;
        }
        body[data-theme="dark"] select,
        body[data-theme="dark"] input,
        body[data-theme="dark"] textarea {
            background-color: #111827;
            color: #f8fafc;
            border-color: #334155;
        }
        body[data-theme="dark"] .border-slate-300,
        body[data-theme="dark"] .border-slate-200,
        body[data-theme="dark"] .border-slate-100,
        body[data-theme="dark"] .border-b {
            border-color: #334155 !important;
        }
        body[data-theme="dark"] .nav-link {
            color: #cbd5f5 !important;
        }
        body[data-theme="dark"] .nav-link.text-blue-600 {
            color: #60a5fa !important;
        }
        body[data-theme="dark"] .nav-link:hover {
            color: #93c5fd !important;
        }
        body[data-theme="dark"] nav {
            background-color: #1f2937 !important;
            border-color: #334155 !important;
        }
        body[data-theme="dark"] .stat-card {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.18), rgba(15, 23, 42, 0.82));
            border: 1px solid rgba(148, 163, 184, 0.25);
        }
        body[data-theme="dark"] .stat-card::after {
            background: radial-gradient(circle at top right, rgba(59, 130, 246, 0.25), transparent 55%);
        }
        body[data-theme="dark"] .detail-card {
            background: linear-gradient(140deg, rgba(15, 23, 42, 0.78), rgba(30, 41, 59, 0.88));
            border-color: rgba(148, 163, 184, 0.25);
            box-shadow: 0 28px 48px rgba(2, 6, 23, 0.55);
        }
        body[data-theme="dark"] .heatmap-cell {
            background: rgba(59, 130, 246, 0.12);
            color: #e2e8f0;
        }
        body[data-theme="dark"] .heatmap-cell:hover {
            box-shadow: 0 12px 22px rgba(8, 47, 73, 0.35);
        }
        body[data-theme="dark"] #notes-heatmap-legend {
            color: #94a3b8 !important;
        }
        body[data-theme="dark"] .tag-pill {
            background: rgba(59, 130, 246, 0.22);
            color: #bfdbfe;
        }
        body[data-theme="dark"] ::-webkit-scrollbar-track {
            background: #1f2937;
        }
        body[data-theme="dark"] ::-webkit-scrollbar-thumb {
            background: #475569;
        }
        body[data-theme="dark"] ::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }
        body[data-theme="dark"] .highlight-surface {
            background: rgba(37, 99, 235, 0.16);
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800" data-page="stats" data-theme="light">

    <div class="container mx-auto p-4 md:p-8 max-w-5xl pb-24">
        <header class="text-center mb-10">
            <h1 class="text-4xl md:text-5xl font-bold text-slate-900">Estadísticas del Diario</h1>
            <p class="text-slate-500 mt-3 max-w-2xl mx-auto text-base md:text-lg">
                Visualiza un resumen de tu actividad, tus hábitos de escritura y la distribución de etiquetas en tus notas guardadas en IndexedDB.
            </p>
        </header>

        <section aria-labelledby="stats-overview-heading" class="mb-12">
            <div class="flex items-center justify-between flex-wrap gap-4 mb-6">
                <div>
                    <h2 id="stats-overview-heading" class="text-2xl font-semibold text-slate-900">Resumen general</h2>
                    <p class="text-sm text-slate-500">Métricas clave de tu diario digital.</p>
                </div>
                <span id="stats-last-update" class="text-xs font-medium text-slate-500 bg-slate-200 px-3 py-1 rounded-full" title="Última actualización disponible">Actualizado: --</span>
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-6">
                <article class="stat-card p-6 border border-slate-200/60 shadow-md">
                    <div class="stat-card-content">
                        <div class="flex items-center justify-between mb-4">
                            <span class="inline-flex items-center gap-2 text-sm font-semibold text-blue-600 stat-highlight px-3 py-1">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-notebook-pen">
                                    <path d="m15 4 1 1 3-3a2 2 0 0 0-3-3l-3 3z"/>
                                    <path d="M10 9l6-6"/>
                                    <path d="M11 4H7a2 2 0 0 0-2 2v14c0 1.1.9 2 2 2h10a2 2 0 0 0 2-2V9"/>
                                </svg>
                                Total de notas
                            </span>
                            <span class="text-xs font-medium text-slate-400">Ítem #1</span>
                        </div>
                        <p id="total-notes-count" class="text-4xl font-bold text-slate-900">0</p>
                        <p class="text-sm text-slate-500 mt-3">Cantidad total de entradas registradas.</p>
                    </div>
                </article>

                <article class="stat-card p-6 border border-slate-200/60 shadow-md">
                    <div class="stat-card-content">
                        <div class="flex items-center justify-between mb-4">
                            <span class="inline-flex items-center gap-2 text-sm font-semibold text-blue-600 stat-highlight px-3 py-1">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-calendar-clock">
                                    <path d="M21 7v10a4 4 0 0 1-4 4H7a4 4 0 0 1-4-4V7"/>
                                    <path d="M16 3v4"/>
                                    <path d="M8 3v4"/>
                                    <path d="M3 11h18"/>
                                    <circle cx="12" cy="16" r="3"/>
                                    <path d="m12 14 1 1-1 1"/>
                                </svg>
                                Promedio semanal
                            </span>
                            <span class="text-xs font-medium text-slate-400">Ítem #2</span>
                        </div>
                        <p id="average-notes-per-week" class="text-4xl font-bold text-slate-900">--</p>
                        <p class="text-sm text-slate-500 mt-3">Notas creadas en promedio cada semana.</p>
                    </div>
                </article>

                <article class="stat-card p-6 border border-slate-200/60 shadow-md">
                    <div class="stat-card-content">
                        <div class="flex items-center justify-between mb-4">
                            <span class="inline-flex items-center gap-2 text-sm font-semibold text-blue-600 stat-highlight px-3 py-1">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-hourglass">
                                    <path d="M19 18H5"/>
                                    <path d="M5 3h14"/>
                                    <path d="M6 3a6 6 0 0 0 12 0"/>
                                    <path d="M6 18a6 6 0 0 1 12 0"/>
                                </svg>
                                Edad del diario
                            </span>
                            <span class="text-xs font-medium text-slate-400">Ítem #3</span>
                        </div>
                        <p id="journal-age" class="text-3xl font-bold text-slate-900">--</p>
                        <p class="text-sm text-slate-500 mt-3">Tiempo transcurrido desde tu primera nota.</p>
                    </div>
                </article>

                <article class="stat-card p-6 border border-slate-200/60 shadow-md">
                    <div class="stat-card-content">
                        <div class="flex items-center justify-between mb-4">
                            <span class="inline-flex items-center gap-2 text-sm font-semibold text-blue-600 stat-highlight px-3 py-1">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-align-left">
                                    <path d="M21 6H3"/>
                                    <path d="M15 12H3"/>
                                    <path d="M17 18H3"/>
                                </svg>
                                Palabras por nota
                            </span>
                            <span class="text-xs font-medium text-slate-400">Ítem #4</span>
                        </div>
                        <p id="average-words-per-note" class="text-3xl font-bold text-slate-900">--</p>
                        <p class="text-sm text-slate-500 mt-3">Promedio de palabras escritas por nota.</p>
                    </div>
                </article>

                <article class="stat-card p-6 border border-slate-200/60 shadow-md">
                    <div class="stat-card-content">
                        <div class="flex items-center justify-between mb-4">
                            <span class="inline-flex items-center gap-2 text-sm font-semibold text-blue-600 stat-highlight px-3 py-1">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-tags">
                                    <path d="M3 6v6a2 2 0 0 0 .59 1.41l7 7a2 2 0 0 0 2.82 0l6-6a2 2 0 0 0 0-2.82l-7-7A2 2 0 0 0 11 3H5a2 2 0 0 0-2 2Z"/>
                                    <path d="M7.5 7.5h.01"/>
                                </svg>
                                Etiquetas por nota
                            </span>
                            <span class="text-xs font-medium text-slate-400">Ítem #5</span>
                        </div>
                        <p id="average-tags-per-note" class="text-3xl font-bold text-slate-900">--</p>
                        <p class="text-sm text-slate-500 mt-3">Promedio de etiquetas asociadas a cada nota.</p>
                    </div>
                </article>

                <article class="stat-card p-6 border border-slate-200/60 shadow-md">
                    <div class="stat-card-content">
                        <div class="flex items-center justify-between mb-4">
                            <span class="inline-flex items-center gap-2 text-sm font-semibold text-blue-600 stat-highlight px-3 py-1">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-sunrise">
                                    <path d="M3 17h18"/>
                                    <path d="M12 5V2"/>
                                    <path d="m4.22 10.22 1.42-1.42"/>
                                    <path d="M1 17h22"/>
                                    <path d="m19.78 10.22-1.42-1.42"/>
                                    <path d="M12 9a4 4 0 0 1 4 4H8a4 4 0 0 1 4-4Z"/>
                                </svg>
                                Franja más activa
                            </span>
                            <span class="text-xs font-medium text-slate-400">Ítem #6</span>
                        </div>
                        <p id="top-time-range" class="text-2xl font-bold text-slate-900">--:-- - --:--</p>
                        <p id="top-time-range-count" class="text-sm text-slate-500 mt-3">Notas registradas en la franja: --</p>
                    </div>
                </article>
            </div>
        </section>

        <section aria-labelledby="notes-distribution-heading" class="mb-12">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6">
                <div>
                    <h2 id="notes-distribution-heading" class="text-2xl font-semibold text-slate-900">Actividad detallada</h2>
                    <p class="text-sm text-slate-500">Explora cada nota y cómo se distribuyen tus etiquetas.</p>
                </div>
                <div class="flex items-center gap-2 text-xs text-slate-500">
                    <span class="inline-flex items-center gap-1 px-3 py-1 rounded-full bg-slate-200 font-semibold">Notas totales: <span id="notes-total-indicator">0</span></span>
                    <span class="inline-flex items-center gap-1 px-3 py-1 rounded-full bg-slate-200 font-semibold">Etiquetas únicas: <span id="tags-total-indicator">0</span></span>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <article class="detail-card p-6">
                    <header class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-slate-900 flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-list-checks text-blue-600">
                                <path d="m9 11 3 3L22 4"/>
                                <path d="M5 19h14"/>
                                <path d="M5 13h14"/>
                                <path d="M5 7h14"/>
                            </svg>
                            Notas registradas <!-- El total en numero -->
                        </h3>
                        <span id="notes-list-empty" class="text-xs font-medium text-slate-400 hidden">Sin datos disponibles</span>
                    </header>
                    <div class="space-y-4 max-h-[420px] overflow-y-auto pr-2" id="notes-list" aria-live="polite"></div>
                    <template id="note-summary-template">
                        <article class="rounded-2xl border border-slate-200 px-4 py-4 bg-white/80 hover:bg-white transition-colors note-summary">
                            <div class="flex items-start justify-between gap-4">
                                <div>
                                    <h4 class="text-base font-semibold text-slate-900" data-note-title>--</h4>
                                    <p class="text-xs text-slate-500 mt-1" data-note-date>--</p>
                                </div>
                                <span class="text-xs font-semibold text-slate-500 bg-slate-200 rounded-full px-3 py-1" data-note-word-count>0 palabras</span>
                            </div>
                            <div class="mt-3 flex flex-wrap gap-2" data-note-tags></div>
                        </article>
                    </template>
                    <template id="note-tag-pill-template">
                        <span class="text-xs font-semibold tag-pill px-3 py-1" data-tag-name>#Etiqueta</span>
                    </template>
                </article>

                <article class="detail-card p-6">
                    <header class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-slate-900 flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-pie-chart text-blue-600">
                                <path d="M21.21 15.89A10 10 0 1 1 13 2.05"/>
                                <path d="M22 12A10 10 0 0 0 12 2v10z"/>
                            </svg>
                            Presencia de etiquetas
                        </h3>
                        <span id="tag-frequency-empty" class="text-xs font-medium text-slate-400 hidden">Sin etiquetas registradas</span>
                    </header>
                    <p class="text-sm text-slate-500 mb-4">Porcentaje de notas en las que está presente cada etiqueta.</p>
                    <div class="space-y-4" id="tag-frequency-list" aria-live="polite"></div>
                    <template id="tag-frequency-template">
                        <div class="border border-slate-200 rounded-2xl px-4 py-4 bg-white/80 hover:bg-white transition-colors">
                            <div class="flex items-start justify-between gap-4">
                                <div>
                                    <h4 class="text-base font-semibold text-slate-900" data-tag-frequency-name>#Etiqueta</h4>
                                    <p class="text-xs text-slate-500 mt-1" data-tag-frequency-count>-- notas</p>
                                </div>
                                <div class="text-right">
                                    <p class="text-2xl font-semibold text-slate-900" data-tag-frequency-percentage>0%</p>
                                    <span class="text-xs text-slate-400">del total</span>
                                </div>
                            </div>
                            <div class="w-full h-2 mt-4 bg-slate-200 rounded-full overflow-hidden">
                                <div class="h-full bg-blue-500 rounded-full" data-tag-frequency-bar style="width: 0%"></div>
                            </div>
                        </div>
                    </template>
                </article>
            </div>
        </section>

        <section aria-labelledby="notes-timeline-heading" class="mb-16">
            <div class="flex items-center justify-between flex-wrap gap-4 mb-6">
                <div>
                    <h2 id="notes-timeline-heading" class="text-2xl font-semibold text-slate-900">Cronología de notas</h2>
                    <p class="text-sm text-slate-500">Análisis comparativo y distribución diaria de tus notas.</p>
                </div>
                <span class="text-xs font-medium text-slate-400">Datos basados en tu historial registrado</span>
            </div>
            <div class="grid grid-cols-1 xl:grid-cols-2 gap-6" id="notes-timeline-grid">
                <article class="detail-card p-6" id="monthly-comparison-card">
                    <header class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-bar-chart-horizontal text-blue-600">
                                <path d="M3 3v18h18"/>
                                <path d="M7 5h12"/>
                                <path d="M7 9h8"/>
                                <path d="M7 13h4"/>
                                <path d="M7 17h10"/>
                            </svg>
                            <h3 class="text-lg font-semibold text-slate-900">Notas por mes</h3>
                        </div>
                    </header>
                    <p class="text-sm text-slate-500 mb-4">Compara la actividad mensual entre el año actual y el anterior.</p>
                    <div class="relative">
                        <canvas id="monthly-comparison-chart" class="w-full h-[320px]" role="img" aria-label="Comparación de notas mensuales"></canvas>
                        <div id="monthly-comparison-message" class="mt-4 text-sm font-medium text-center text-slate-500 hidden"></div>
                    </div>
                </article>

                <article class="detail-card p-6" id="notes-heatmap-card">
                    <header class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-calendar-heart text-blue-600">
                                <path d="M21 7h-6"/>
                                <path d="M11 7H3"/>
                                <path d="M21 3h-6"/>
                                <path d="M11 3H3"/>
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V9a2 2 0 0 1 2-2h16"/>
                                <path d="m16 19-2-2a2.828 2.828 0 0 1 4-4l.586.586"/>
                                <path d="M21 11.586 16.586 16"/>
                            </svg>
                            <h3 class="text-lg font-semibold text-slate-900">Mapa de calor diario</h3>
                        </div>
                        <div class="flex items-center gap-2">
                            <button type="button" id="notes-heatmap-prev" class="flex items-center justify-center rounded-full border border-slate-200 text-slate-500 hover:text-blue-600 hover:border-blue-200 transition-colors w-9 h-9" aria-label="Mes anterior">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-left">
                                    <path d="m15 18-6-6 6-6"/>
                                </svg>
                            </button>
                            <span id="notes-heatmap-month-label" class="text-sm font-semibold text-slate-600"></span>
                            <button type="button" id="notes-heatmap-next" class="flex items-center justify-center rounded-full border border-slate-200 text-slate-500 hover:text-blue-600 hover:border-blue-200 transition-colors w-9 h-9" aria-label="Mes siguiente">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-right">
                                    <path d="m9 18 6-6-6-6"/>
                                </svg>
                            </button>
                        </div>
                    </header>
                    <p class="text-sm text-slate-500 mb-4">Identifica los días con mayor cantidad de notas y navega por tus meses registrados.</p>
                    <div id="notes-heatmap-message" class="text-sm font-medium text-center text-slate-500 hidden"></div>
                    <div class="grid grid-cols-7 gap-2 text-xs font-semibold uppercase tracking-wide text-slate-500 mb-3" id="notes-heatmap-weekdays" aria-hidden="true"></div>
                    <div id="notes-heatmap-grid" class="grid grid-cols-7 gap-2" aria-live="polite" aria-label="Mapa de calor de notas"></div>
                    <p class="text-xs text-slate-400 mt-4" id="notes-heatmap-legend">La intensidad del color representa la proporción de notas registradas por día.</p>
                </article>
            </div>
        </section>
    </div>

    <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 shadow-[0_-2px_10px_rgba(0,0,0,0.05)] flex justify-around items-center h-16 z-30">
        <a href="index.html" class="nav-link flex flex-col items-center justify-center w-full h-full text-slate-500 hover:text-blue-600 transition-colors duration-200">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-notebook-tabs">
                <path d="M2 6h4"/>
                <path d="M2 10h4"/>
                <path d="M2 14h4"/>
                <path d="M2 18h4"/>
                <rect width="16" height="20" x="4" y="2" rx="2"/>
                <path d="M15 2v20"/>
                <path d="M15 7h5"/>
                <path d="M15 12h5"/>
                <path d="M15 17h5"/>
            </svg>
            <span class="text-xs font-medium mt-1">Notas</span>
        </a>
        <a href="historial.html" class="nav-link flex flex-col items-center justify-center w-full h-full text-slate-500 hover:text-blue-600 transition-colors duration-200">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-history">
                <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/>
                <path d="M3 3v5h5"/>
            </svg>
            <span class="text-xs font-medium mt-1">Historial</span>
        </a>
        <a href="estadistica.html" class="nav-link flex flex-col items-center justify-center w-full h-full text-blue-600 transition-colors duration-200">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-bar-chart-3">
                <path d="M3 3v18h18"/>
                <path d="M13 13h4v5h-4z"/>
                <path d="M6 16h4v2H6z"/>
                <path d="M18 9h4v9h-4z"/>
            </svg>
            <span class="text-xs font-medium mt-1">Estadísticas</span>
        </a>
        <a href="reflexion.html" class="nav-link flex flex-col items-center justify-center w-full h-full text-slate-500 hover:text-blue-600 transition-colors duration-200">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-lamp-desk">
                <path d="M13 5h7"/>
                <path d="M13 9h4"/>
                <path d="M10 12h8"/>
                <path d="M16 9c0 2.8-1.2 4.7-3 6"/>
                <path d="M12 3a4 4 0 0 0-8 1v6l2 4h4l2-4v-6"/>
                <path d="M8 17v4"/>
                <path d="M6 21h4"/>
            </svg>
            <span class="text-xs font-medium mt-1">Reflexión</span>
        </a>
        <a href="ajustes.html" class="nav-link flex flex-col items-center justify-center w-full h-full text-slate-500 hover:text-blue-600 transition-colors duración-200">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-settings">
                <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 0 2l-.15.08a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l-.22-.38a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1 0-2l.15-.08a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/>
                <circle cx="12" cy="12" r="3"/>
            </svg>
            <span class="text-xs font-medium mt-1">Ajustes</span>
        </a>
    </nav>

    <script src="app.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const statsLastUpdateEl = document.getElementById('stats-last-update');
            const totalNotesCountEl = document.getElementById('total-notes-count');
            const averageNotesPerWeekEl = document.getElementById('average-notes-per-week');
            const journalAgeEl = document.getElementById('journal-age');
            const averageWordsPerNoteEl = document.getElementById('average-words-per-note');
            const averageTagsPerNoteEl = document.getElementById('average-tags-per-note');
            const topTimeRangeEl = document.getElementById('top-time-range');
            const topTimeRangeCountEl = document.getElementById('top-time-range-count');
            const notesTotalIndicatorEl = document.getElementById('notes-total-indicator');
            const tagsTotalIndicatorEl = document.getElementById('tags-total-indicator');
            const notesListEl = document.getElementById('notes-list');
            const notesListEmptyEl = document.getElementById('notes-list-empty');
            const noteSummaryTemplate = document.getElementById('note-summary-template');
            const noteTagTemplate = document.getElementById('note-tag-pill-template');
            const tagFrequencyListEl = document.getElementById('tag-frequency-list');
            const tagFrequencyEmptyEl = document.getElementById('tag-frequency-empty');
            const tagFrequencyTemplate = document.getElementById('tag-frequency-template');
            const monthlyComparisonCanvas = document.getElementById('monthly-comparison-chart');
            const monthlyComparisonMessageEl = document.getElementById('monthly-comparison-message');
            const notesHeatmapWeekdaysEl = document.getElementById('notes-heatmap-weekdays');
            const notesHeatmapGridEl = document.getElementById('notes-heatmap-grid');
            const notesHeatmapPrevBtn = document.getElementById('notes-heatmap-prev');
            const notesHeatmapNextBtn = document.getElementById('notes-heatmap-next');
            const notesHeatmapMonthLabelEl = document.getElementById('notes-heatmap-month-label');
            const notesHeatmapMessageEl = document.getElementById('notes-heatmap-message');
            const notesHeatmapLegendEl = document.getElementById('notes-heatmap-legend');
            const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            const weekdayLabels = ['Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb', 'Dom'];
            let cachedNotes = [];
            let monthlyComparisonChart = null;
            let heatmapReferenceDate = null;
            let refreshVisualizations = () => {};

            const DB_NAME = 'NotesDB';
            const DB_VERSION = 6;
            const NOTES_STORE = 'notes';
            const TAGS_STORE = 'tags';
            const dayInMs = 24 * 60 * 60 * 1000;

            const timeRanges = [
                { label: 'Madrugada', rangeLabel: '00:00 - 05:59', predicate: (hour) => hour >= 0 && hour < 6 },
                { label: 'Mañana', rangeLabel: '06:00 - 11:59', predicate: (hour) => hour >= 6 && hour < 12 },
                { label: 'Tarde', rangeLabel: '12:00 - 17:59', predicate: (hour) => hour >= 12 && hour < 18 },
                { label: 'Noche', rangeLabel: '18:00 - 23:59', predicate: (hour) => hour >= 18 && hour < 24 }
            ];

            const defaultNotesEmptyText = notesListEmptyEl?.textContent?.trim() || 'Sin datos disponibles';
            const defaultTagEmptyText = tagFrequencyEmptyEl?.textContent?.trim() || 'Sin etiquetas registradas';
            const defaultMonthlyMessage = monthlyComparisonMessageEl?.textContent?.trim() || 'Sin datos suficientes para generar el gráfico de comparación.';
            const defaultHeatmapMessage = notesHeatmapMessageEl?.textContent?.trim() || 'Sin datos registrados para este mes.';

            const getCurrentTheme = () => document.body?.dataset?.theme || 'light';

            const normalizeHex = (hex) => {
                if (typeof hex !== 'string') return '';
                const trimmed = hex.trim();
                if (!trimmed) return '';
                if (trimmed.startsWith('#')) {
                    if (trimmed.length === 4) {
                        return `#${trimmed[1]}${trimmed[1]}${trimmed[2]}${trimmed[2]}${trimmed[3]}${trimmed[3]}`;
                    }
                    if (trimmed.length === 7) {
                        return trimmed;
                    }
                    return '';
                }
                if (trimmed.length === 3) {
                    return `#${trimmed[0]}${trimmed[0]}${trimmed[1]}${trimmed[1]}${trimmed[2]}${trimmed[2]}`;
                }
                if (trimmed.length === 6) {
                    return `#${trimmed}`;
                }
                return '';
            };

            const hexToRgb = (hex) => {
                const normalized = normalizeHex(hex);
                if (!normalized) return null;
                const value = normalized.slice(1);
                const parsed = parseInt(value, 16);
                if (Number.isNaN(parsed)) return null;
                return {
                    r: (parsed >> 16) & 255,
                    g: (parsed >> 8) & 255,
                    b: parsed & 255
                };
            };

            const rgbToHex = ({ r, g, b }) => {
                const clamp = (value) => Math.max(0, Math.min(255, Math.round(value)));
                return `#${[clamp(r), clamp(g), clamp(b)].map((component) => component.toString(16).padStart(2, '0')).join('')}`;
            };

            const srgbChannelToLinear = (channel) => {
                const normalized = channel / 255;
                return normalized <= 0.03928
                    ? normalized / 12.92
                    : Math.pow((normalized + 0.055) / 1.055, 2.4);
            };

            const getRelativeLuminance = ({ r, g, b }) => {
                const rLin = srgbChannelToLinear(r);
                const gLin = srgbChannelToLinear(g);
                const bLin = srgbChannelToLinear(b);
                return (0.2126 * rLin) + (0.7152 * gLin) + (0.0722 * bLin);
            };

            const adjustColorForTheme = (hexColor) => {
                const sanitized = normalizeHex(hexColor);
                if (!sanitized) return '';
                if (getCurrentTheme() !== 'dark') return sanitized;
                const rgb = hexToRgb(sanitized);
                if (!rgb) return sanitized;
                const lightenFactor = 0.25;
                const adjustChannel = (channel) => channel + (255 - channel) * lightenFactor;
                const adjustedRgb = {
                    r: adjustChannel(rgb.r),
                    g: adjustChannel(rgb.g),
                    b: adjustChannel(rgb.b)
                };
                return rgbToHex(adjustedRgb);
            };

            const getAccessibleTextColor = (hexColor) => {
                const fallback = getCurrentTheme() === 'dark' ? '#f8fafc' : '#0f172a';
                const rgb = hexToRgb(hexColor);
                if (!rgb) return fallback;
                const luminance = getRelativeLuminance(rgb);
                return luminance >= 0.55 ? '#0f172a' : '#f8fafc';
            };

            const applyTagPillStyles = (pillEl, tagColor) => {
                if (!pillEl) return;
                const sanitizedColor = normalizeHex(tagColor);
                pillEl.setAttribute('data-dynamic-tag-pill', 'true');
                pillEl.dataset.tagColor = sanitizedColor;
                if (!sanitizedColor) {
                    pillEl.style.backgroundColor = '';
                    pillEl.style.color = '';
                    pillEl.style.borderColor = '';
                    return;
                }
                const themedColor = adjustColorForTheme(sanitizedColor) || sanitizedColor;
                pillEl.style.backgroundColor = themedColor;
                pillEl.style.color = getAccessibleTextColor(themedColor);
                pillEl.style.borderColor = 'transparent';
            };

            const applyTagAccentStyles = (element, tagColor) => {
                if (!element) return;
                const sanitizedColor = normalizeHex(tagColor);
                element.setAttribute('data-dynamic-tag-accent', 'true');
                element.dataset.tagColor = sanitizedColor;
                if (!sanitizedColor) {
                    element.style.color = getCurrentTheme() === 'dark' ? '#f8fafc' : '#0f172a';
                    return;
                }
                const themedColor = adjustColorForTheme(sanitizedColor) || sanitizedColor;
                element.style.color = themedColor;
            };

            const applyTagBarStyles = (element, tagColor) => {
                if (!element) return;
                const sanitizedColor = normalizeHex(tagColor);
                element.setAttribute('data-dynamic-tag-bar', 'true');
                element.dataset.tagColor = sanitizedColor;
                if (!sanitizedColor) {
                    element.style.backgroundColor = '';
                    element.style.opacity = '';
                    return;
                }
                const themedColor = adjustColorForTheme(sanitizedColor) || sanitizedColor;
                element.style.backgroundColor = themedColor;
                element.style.opacity = getCurrentTheme() === 'dark' ? '0.85' : '1';
            };

            const applyDynamicThemeStyles = () => {
                document.querySelectorAll('[data-dynamic-tag-pill]').forEach((pill) => {
                    applyTagPillStyles(pill, pill.dataset.tagColor || '');
                });
                document.querySelectorAll('[data-dynamic-tag-accent]').forEach((accent) => {
                    applyTagAccentStyles(accent, accent.dataset.tagColor || '');
                });
                document.querySelectorAll('[data-dynamic-tag-bar]').forEach((bar) => {
                    applyTagBarStyles(bar, bar.dataset.tagColor || '');
                });
                if (typeof refreshVisualizations === 'function') {
                    refreshVisualizations('theme-update');
                }
            };

            const applyDynamicCardTextColor = (element) => {
                if (!element) return;
                element.style.color = '#0f172a';
            };

            const observeThemeChanges = () => {
                const body = document.body;
                if (!body || typeof MutationObserver !== 'function') return;
                const observer = new MutationObserver((mutations) => {
                    const themeChanged = mutations.some((mutation) => mutation.attributeName === 'data-theme');
                    if (themeChanged) {
                        applyDynamicThemeStyles();
                    }
                });
                observer.observe(body, { attributes: true, attributeFilter: ['data-theme'] });
            };

            observeThemeChanges();

            const setText = (el, text) => {
                if (!el) return;
                el.textContent = text;
            };

            const toggleHidden = (el, hidden) => {
                if (!el) return;
                el.classList.toggle('hidden', hidden);
            };

            const showStatusMessage = (element, message, variant = 'info') => {
                if (!element) return;
                setText(element, message);
                element.classList.remove('hidden');
                if (variant === 'error') {
                    element.classList.add('text-red-500');
                    element.classList.remove('text-slate-500');
                } else {
                    element.classList.remove('text-red-500');
                    element.classList.add('text-slate-500');
                }
            };

            const hideStatusMessage = (element) => {
                if (!element) return;
                element.classList.add('hidden');
                element.classList.remove('text-red-500');
                element.classList.add('text-slate-500');
                setText(element, '');
            };

            const getStartOfMonth = (date) => {
                const reference = date instanceof Date && !Number.isNaN(date.getTime()) ? new Date(date) : new Date();
                return new Date(reference.getFullYear(), reference.getMonth(), 1);
            };

            const formatMonthYearLabel = (date) => {
                const reference = date instanceof Date && !Number.isNaN(date.getTime()) ? date : new Date();
                return `${monthNames[reference.getMonth()]} ${reference.getFullYear()}`;
            };

            const ensureHeatmapWeekdayHeader = () => {
                if (!notesHeatmapWeekdaysEl || !Array.isArray(weekdayLabels)) return;
                if (notesHeatmapWeekdaysEl.dataset.rendered === 'true') return;
                notesHeatmapWeekdaysEl.innerHTML = '';
                weekdayLabels.forEach((label) => {
                    const span = document.createElement('span');
                    span.textContent = label;
                    notesHeatmapWeekdaysEl.appendChild(span);
                });
                notesHeatmapWeekdaysEl.dataset.rendered = 'true';
            };

            const describeNotesCount = (count) => {
                if (!Number.isFinite(count)) return '0 notas';
                const rounded = Math.max(0, Math.trunc(count));
                return `${rounded.toLocaleString('es-ES')} ${rounded === 1 ? 'nota' : 'notas'}`;
            };

            const getHeatmapIntensityColor = (count, maxCount) => {
                const theme = getCurrentTheme();
                if (!Number.isFinite(maxCount) || maxCount <= 0 || !Number.isFinite(count) || count <= 0) {
                    return theme === 'dark' ? 'rgba(59, 130, 246, 0.18)' : 'rgba(148, 163, 184, 0.12)';
                }
                const normalizedCount = Math.min(1, Math.max(0, count / maxCount));
                const baseHex = theme === 'dark' ? '#60a5fa' : '#2563eb';
                const baseRgb = hexToRgb(baseHex);
                if (!baseRgb) {
                    return theme === 'dark' ? 'rgba(59, 130, 246, 0.45)' : 'rgba(37, 99, 235, 0.35)';
                }
                const minAlpha = theme === 'dark' ? 0.28 : 0.2;
                const maxAlpha = theme === 'dark' ? 0.82 : 0.72;
                const alpha = minAlpha + (maxAlpha - minAlpha) * normalizedCount;
                return `rgba(${baseRgb.r}, ${baseRgb.g}, ${baseRgb.b}, ${alpha.toFixed(3)})`;
            };

            const getHeatmapTextColor = (count, maxCount) => {
                const theme = getCurrentTheme();
                if (!Number.isFinite(maxCount) || maxCount <= 0 || !Number.isFinite(count) || count <= 0) {
                    return theme === 'dark' ? '#94a3b8' : '#475569';
                }
                const normalizedCount = Math.min(1, Math.max(0, count / maxCount));
                if (normalizedCount >= 0.7) {
                    return '#f8fafc';
                }
                if (normalizedCount >= 0.4) {
                    return theme === 'dark' ? '#f1f5f9' : '#0f172a';
                }
                return theme === 'dark' ? '#cbd5f5' : '#1e293b';
            };

            const formatNumber = (value, options = {}) => {
                if (!Number.isFinite(value)) return '--';
                const defaults = value >= 100 ? { maximumFractionDigits: 0 } : { maximumFractionDigits: 1 };
                return value.toLocaleString('es-ES', { ...defaults, ...options });
            };

            const countWords = (text) => {
                if (typeof text !== 'string') return 0;
                const trimmed = text.trim();
                if (!trimmed) return 0;
                return trimmed.split(/\s+/).filter(Boolean).length;
            };

            const formatJournalAge = (firstDate) => {
                if (!(firstDate instanceof Date) || Number.isNaN(firstDate.getTime())) return '--';
                const now = new Date();
                let diffMs = now.getTime() - firstDate.getTime();
                if (diffMs < 0) diffMs = 0;

                if (diffMs < dayInMs) {
                    const hours = Math.max(1, Math.round(diffMs / (60 * 60 * 1000)));
                    return `${hours} ${hours === 1 ? 'hora' : 'horas'}`;
                }

                const days = Math.round(diffMs / dayInMs);
                if (days < 30) {
                    return `${days} ${days === 1 ? 'día' : 'días'}`;
                }

                const months = Math.round(days / 30);
                if (months < 12) {
                    return `${months} ${months === 1 ? 'mes' : 'meses'}`;
                }

                const years = Math.max(1, Math.round(months / 12));
                return `${years} ${years === 1 ? 'año' : 'años'}`;
            };

            const requestToPromise = (request) => new Promise((resolve, reject) => {
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });

            const resetStats = () => {
                setText(statsLastUpdateEl, 'Actualizado: --');
                setText(totalNotesCountEl, '0');
                setText(averageNotesPerWeekEl, '--');
                setText(journalAgeEl, '--');
                setText(averageWordsPerNoteEl, '--');
                setText(averageTagsPerNoteEl, '--');
                setText(topTimeRangeEl, '--:-- - --:--');
                setText(topTimeRangeCountEl, 'Notas registradas en la franja: --');
                setText(notesTotalIndicatorEl, '0');
                setText(tagsTotalIndicatorEl, '0');
                if (notesListEl) notesListEl.innerHTML = '';
                if (tagFrequencyListEl) tagFrequencyListEl.innerHTML = '';
            };

            const showEmptyState = () => {
                resetStats();
                toggleHidden(notesListEmptyEl, false);
                toggleHidden(tagFrequencyEmptyEl, false);
                setText(notesListEmptyEl, defaultNotesEmptyText);
                setText(tagFrequencyEmptyEl, defaultTagEmptyText);
                cachedNotes = [];
                heatmapReferenceDate = getStartOfMonth(new Date());
                if (typeof refreshVisualizations === 'function') {
                    refreshVisualizations('empty-state', []);
                }
            };

            const renderNotesList = (notes, tagsMap) => {
                if (!notesListEl || !noteSummaryTemplate) return;
                notesListEl.innerHTML = '';

                if (!Array.isArray(notes) || notes.length === 0) {
                    showEmptyState();
                    return;
                }

                const sortedNotes = [...notes].sort((a, b) => b.id - a.id);
                sortedNotes.forEach((note) => {
                    const fragment = noteSummaryTemplate.content.cloneNode(true);
                    const titleEl = fragment.querySelector('[data-note-title]');
                    const dateEl = fragment.querySelector('[data-note-date]');
                    const wordCountEl = fragment.querySelector('[data-note-word-count]');
                    const tagsContainerEl = fragment.querySelector('[data-note-tags]');

                    const rawTitle = typeof note.title === 'string' ? note.title.trim() : '';
                    const title = rawTitle || 'Nota sin título';
                    const noteDate = new Date(note.id);
                    const dateLabel = Number.isNaN(noteDate.getTime())
                        ? 'Fecha desconocida'
                        : noteDate.toLocaleString('es-ES', { dateStyle: 'long', timeStyle: 'short' });
                    const wordCount = countWords(note.content);

                    setText(titleEl, title);
                    setText(dateEl, dateLabel);
                    setText(wordCountEl, `${wordCount.toLocaleString('es-ES')} ${wordCount === 1 ? 'palabra' : 'palabras'}`);

                    if (tagsContainerEl) {
                        tagsContainerEl.innerHTML = '';
                        const uniqueTags = Array.from(new Set(Array.isArray(note.tags) ? note.tags : []));
                        if (uniqueTags.length === 0) {
                            toggleHidden(tagsContainerEl, true);
                        } else {
                            toggleHidden(tagsContainerEl, false);
                            uniqueTags.forEach((tagName) => {
                                const tagInfo = tagsMap instanceof Map ? tagsMap.get(tagName) : undefined;
                                const tagColor = typeof tagInfo?.color === 'string' ? tagInfo.color : '';
                                if (noteTagTemplate) {
                                    const tagFragment = noteTagTemplate.content.cloneNode(true);
                                    const pillEl = tagFragment.querySelector('[data-tag-name]');
                                    if (pillEl) {
                                        pillEl.textContent = `#${tagName}`;
                                        applyTagPillStyles(pillEl, tagColor);
                                    }
                                    tagsContainerEl.appendChild(tagFragment);
                                } else {
                                    const span = document.createElement('span');
                                    span.className = 'text-xs font-semibold tag-pill px-3 py-1';
                                    span.textContent = `#${tagName}`;
                                    applyTagPillStyles(span, tagColor);
                                    tagsContainerEl.appendChild(span);
                                }
                            });
                        }
                    }

                    const noteCardEl = fragment.querySelector('.note-summary');
                    applyDynamicCardTextColor(noteCardEl);

                    notesListEl.appendChild(fragment);
                });

                toggleHidden(notesListEmptyEl, true);
                setText(notesListEmptyEl, defaultNotesEmptyText);
            };

            const renderTagFrequency = (notes, tagsMap) => {
                if (!tagFrequencyListEl || !tagFrequencyTemplate) return;
                tagFrequencyListEl.innerHTML = '';

                if (!Array.isArray(notes) || notes.length === 0) {
                    toggleHidden(tagFrequencyEmptyEl, false);
                    setText(tagFrequencyEmptyEl, defaultTagEmptyText);
                    return;
                }

                const tagPresence = new Map();
                notes.forEach((note) => {
                    const uniqueTags = Array.from(new Set(Array.isArray(note.tags) ? note.tags : []));
                    uniqueTags.forEach((tag) => {
                        tagPresence.set(tag, (tagPresence.get(tag) || 0) + 1);
                    });
                });

                if (tagPresence.size === 0) {
                    toggleHidden(tagFrequencyEmptyEl, false);
                    setText(tagFrequencyEmptyEl, defaultTagEmptyText);
                    return;
                }

                const totalNotes = notes.length;
                [...tagPresence.entries()]
                    .sort((a, b) => b[1] - a[1])
                    .forEach(([tagName, count]) => {
                        const fragment = tagFrequencyTemplate.content.cloneNode(true);
                        const nameEl = fragment.querySelector('[data-tag-frequency-name]');
                        const countEl = fragment.querySelector('[data-tag-frequency-count]');
                        const percentageEl = fragment.querySelector('[data-tag-frequency-percentage]');
                        const barEl = fragment.querySelector('[data-tag-frequency-bar]');

                        const percentage = (count / totalNotes) * 100;
                        setText(nameEl, `#${tagName}`);
                        setText(countEl, `${count.toLocaleString('es-ES')} ${count === 1 ? 'nota' : 'notas'}`);
                        setText(percentageEl, `${percentage.toFixed(1)}%`);
                        if (barEl) {
                            barEl.style.width = `${Math.min(100, percentage)}%`;
                        }

                        const tagInfo = tagsMap.get(tagName);
                        const tagColor = typeof tagInfo?.color === 'string' ? tagInfo.color : '';
                        if (nameEl) {
                            applyTagAccentStyles(nameEl, tagColor);
                        }
                        if (barEl) {
                            applyTagBarStyles(barEl, tagColor);
                        }

                        applyDynamicCardTextColor(fragment.firstElementChild);

                        tagFrequencyListEl.appendChild(fragment);
                    });

                toggleHidden(tagFrequencyEmptyEl, true);
                setText(tagFrequencyEmptyEl, defaultTagEmptyText);
            };

            const updateOverview = (notes, tagsMap) => {
                if (!Array.isArray(notes) || notes.length === 0) {
                    showEmptyState();
                    return;
                }

                const sortedByDate = [...notes].sort((a, b) => a.id - b.id);
                const firstNoteDate = new Date(sortedByDate[0].id);
                const lastNoteDate = new Date(sortedByDate[sortedByDate.length - 1].id);
                const totalNotes = notes.length;
                const uniqueTags = new Set();
                let totalWords = 0;
                let totalNoteTags = 0;

                const rangeCounters = timeRanges.map(() => 0);

                notes.forEach((note) => {
                    totalWords += countWords(note.content);
                    const noteTags = Array.isArray(note.tags) ? note.tags : [];
                    totalNoteTags += noteTags.length;
                    noteTags.forEach((tag) => uniqueTags.add(tag));

                    const noteDate = new Date(note.id);
                    if (!Number.isNaN(noteDate.getTime())) {
                        const hour = noteDate.getHours();
                        timeRanges.forEach((item, index) => {
                            if (item.predicate(hour)) {
                                rangeCounters[index] += 1;
                            }
                        });
                    }
                });

                const spanMs = Math.max(1, lastNoteDate.getTime() - firstNoteDate.getTime());
                const spanWeeks = Math.max(1, spanMs / (7 * dayInMs));
                const averagePerWeek = totalNotes / spanWeeks;
                const averageWords = totalWords / totalNotes;
                const averageTags = totalNoteTags / totalNotes;

                const bestRangeIndex = rangeCounters.reduce((bestIndex, value, index) => {
                    if (value > rangeCounters[bestIndex]) return index;
                    return bestIndex;
                }, 0);
                const bestRangeCount = rangeCounters[bestRangeIndex];

                setText(totalNotesCountEl, totalNotes.toLocaleString('es-ES'));
                setText(averageNotesPerWeekEl, formatNumber(averagePerWeek));
                setText(journalAgeEl, formatJournalAge(firstNoteDate));
                setText(averageWordsPerNoteEl, formatNumber(averageWords));
                setText(averageTagsPerNoteEl, formatNumber(averageTags));
                setText(notesTotalIndicatorEl, totalNotes.toLocaleString('es-ES'));
                setText(tagsTotalIndicatorEl, uniqueTags.size.toLocaleString('es-ES'));

                if (bestRangeCount > 0) {
                    const bestRange = timeRanges[bestRangeIndex];
                    setText(topTimeRangeEl, bestRange.rangeLabel);
                    setText(topTimeRangeCountEl, `Notas registradas en la franja: ${bestRangeCount.toLocaleString('es-ES')}`);
                } else {
                    setText(topTimeRangeEl, '--:-- - --:--');
                    setText(topTimeRangeCountEl, 'Notas registradas en la franja: --');
                }

                if (!Number.isNaN(lastNoteDate.getTime())) {
                    const formattedDate = lastNoteDate.toLocaleString('es-ES', { dateStyle: 'medium', timeStyle: 'short' });
                    setText(statsLastUpdateEl, `Actualizado: ${formattedDate}`);
                } else {
                    setText(statsLastUpdateEl, 'Actualizado: --');
                }

                toggleHidden(notesListEmptyEl, true);
                setText(notesListEmptyEl, defaultNotesEmptyText);
                toggleHidden(tagFrequencyEmptyEl, true);
                setText(tagFrequencyEmptyEl, defaultTagEmptyText);

                renderNotesList(notes, tagsMap);
                renderTagFrequency(notes, tagsMap);
                applyDynamicThemeStyles();
                cachedNotes = Array.isArray(notes) ? notes : [];
                const latestNoteDate = new Date(sortedByDate[sortedByDate.length - 1].id);
                heatmapReferenceDate = Number.isNaN(latestNoteDate.getTime()) ? getStartOfMonth(new Date()) : getStartOfMonth(latestNoteDate);
                refreshVisualizations('data-update', cachedNotes);
            };

            const computeMonthlyCounts = (notes) => {
                const result = {
                    currentYear: Array(12).fill(0),
                    previousYear: Array(12).fill(0),
                    currentYearValue: new Date().getFullYear(),
                    previousYearValue: new Date().getFullYear() - 1
                };
                if (!Array.isArray(notes)) return result;
                notes.forEach((note) => {
                    if (typeof note?.id !== 'number') return;
                    const date = new Date(note.id);
                    if (Number.isNaN(date.getTime())) return;
                    const year = date.getFullYear();
                    const month = date.getMonth();
                    if (year === result.currentYearValue) {
                        result.currentYear[month] += 1;
                    } else if (year === result.previousYearValue) {
                        result.previousYear[month] += 1;
                    }
                });
                return result;
            };

            const getMonthlyChartColors = () => {
                const theme = getCurrentTheme();
                return theme === 'dark'
                    ? {
                        current: 'rgba(96, 165, 250, 0.75)',
                        currentBorder: 'rgba(96, 165, 250, 1)',
                        previous: 'rgba(147, 197, 253, 0.4)',
                        previousBorder: 'rgba(147, 197, 253, 1)',
                        grid: 'rgba(148, 163, 184, 0.35)',
                        ticks: '#cbd5f5'
                    }
                    : {
                        current: 'rgba(37, 99, 235, 0.75)',
                        currentBorder: 'rgba(37, 99, 235, 1)',
                        previous: 'rgba(148, 163, 184, 0.35)',
                        previousBorder: 'rgba(148, 163, 184, 1)',
                        grid: 'rgba(148, 163, 184, 0.35)',
                        ticks: '#475569'
                    };
            };

            const renderMonthlyComparisonChart = (notes) => {
                if (!monthlyComparisonCanvas || typeof Chart !== 'function') return;
                hideStatusMessage(monthlyComparisonMessageEl);
                const data = computeMonthlyCounts(notes);
                const totalCurrent = data.currentYear.reduce((acc, value) => acc + value, 0);
                const totalPrevious = data.previousYear.reduce((acc, value) => acc + value, 0);
                const colors = getMonthlyChartColors();

                if (totalCurrent === 0 && totalPrevious === 0) {
                    showStatusMessage(monthlyComparisonMessageEl, defaultMonthlyMessage, 'info');
                    if (monthlyComparisonChart) {
                        monthlyComparisonChart.destroy();
                        monthlyComparisonChart = null;
                    }
                    return;
                }

                const config = {
                    type: 'bar',
                    data: {
                        labels: monthNames,
                        datasets: [
                            {
                                label: `${data.currentYearValue}`,
                                data: data.currentYear,
                                backgroundColor: colors.current,
                                borderColor: colors.currentBorder,
                                borderWidth: 1.5,
                                borderRadius: 6,
                                maxBarThickness: 32
                            },
                            {
                                label: `${data.previousYearValue}`,
                                data: data.previousYear,
                                backgroundColor: colors.previous,
                                borderColor: colors.previousBorder,
                                borderWidth: 1.5,
                                borderRadius: 6,
                                maxBarThickness: 32
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false
                        },
                        scales: {
                            x: {
                                stacked: false,
                                grid: {
                                    display: false
                                },
                                ticks: {
                                    color: colors.ticks,
                                    font: {
                                        family: 'Inter'
                                    }
                                }
                            },
                            y: {
                                beginAtZero: true,
                                grid: {
                                    color: colors.grid,
                                    drawBorder: false
                                },
                                ticks: {
                                    color: colors.ticks,
                                    precision: 0,
                                    font: {
                                        family: 'Inter'
                                    }
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                labels: {
                                    color: colors.ticks,
                                    font: {
                                        family: 'Inter',
                                        weight: '600'
                                    }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: (context) => {
                                        const value = context.parsed.y;
                                        return `${context.dataset.label}: ${value.toLocaleString('es-ES')} ${value === 1 ? 'nota' : 'notas'}`;
                                    }
                                }
                            }
                        }
                    }
                };

                try {
                    if (monthlyComparisonChart) {
                        monthlyComparisonChart.destroy();
                    }
                    monthlyComparisonChart = new Chart(monthlyComparisonCanvas.getContext('2d'), config);
                } catch (error) {
                    console.error('No fue posible renderizar el gráfico mensual.', error);
                    showStatusMessage(monthlyComparisonMessageEl, 'Ocurrió un error al crear el gráfico mensual.', 'error');
                }
            };

            const computeHeatmapData = (notes, referenceDate) => {
                const startDate = getStartOfMonth(referenceDate);
                const year = startDate.getFullYear();
                const month = startDate.getMonth();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const countsPerDay = Array(daysInMonth).fill(0);
                if (Array.isArray(notes)) {
                    notes.forEach((note) => {
                        if (typeof note?.id !== 'number') return;
                        const date = new Date(note.id);
                        if (Number.isNaN(date.getTime())) return;
                        if (date.getFullYear() === year && date.getMonth() === month) {
                            const dayIndex = date.getDate() - 1;
                            if (dayIndex >= 0 && dayIndex < countsPerDay.length) {
                                countsPerDay[dayIndex] += 1;
                            }
                        }
                    });
                }
                return {
                    startDate,
                    year,
                    month,
                    daysInMonth,
                    countsPerDay,
                    maxCount: Math.max(...countsPerDay, 0)
                };
            };

            const renderNotesHeatmap = (notes, referenceDate) => {
                if (!notesHeatmapGridEl) return;
                hideStatusMessage(notesHeatmapMessageEl);
                ensureHeatmapWeekdayHeader();
                const heatmapData = computeHeatmapData(notes, referenceDate);
                if (!Array.isArray(heatmapData.countsPerDay) || heatmapData.countsPerDay.length === 0) {
                    showStatusMessage(notesHeatmapMessageEl, defaultHeatmapMessage, 'info');
                    notesHeatmapGridEl.innerHTML = '';
                    return;
                }

                const { daysInMonth, countsPerDay, maxCount, startDate } = heatmapData;
                notesHeatmapGridEl.innerHTML = '';
                setText(notesHeatmapMonthLabelEl, formatMonthYearLabel(startDate));
                const firstDayIndex = (startDate.getDay() + 6) % 7; // convertir domingo=0 a lunes=0

                for (let i = 0; i < firstDayIndex; i += 1) {
                    const placeholder = document.createElement('div');
                    placeholder.className = 'heatmap-cell heatmap-cell__blank';
                    notesHeatmapGridEl.appendChild(placeholder);
                }

                countsPerDay.forEach((count, index) => {
                    const cell = document.createElement('div');
                    cell.className = 'heatmap-cell';
                    const dayNumber = index + 1;
                    const intensity = getHeatmapIntensityColor(count, maxCount);
                    const textColor = getHeatmapTextColor(count, maxCount);
                    cell.style.backgroundColor = intensity;
                    cell.style.color = textColor;

                    const dateLabel = document.createElement('span');
                    dateLabel.className = 'heatmap-cell__date';
                    dateLabel.textContent = dayNumber.toString();

                    const countLabel = document.createElement('span');
                    countLabel.className = 'heatmap-cell__count';
                    if (count <= 0) {
                        countLabel.textContent = '-';
                        countLabel.classList.add('heatmap-cell__empty');
                    } else {
                        countLabel.textContent = count.toLocaleString('es-ES');
                    }

                    cell.appendChild(dateLabel);
                    cell.appendChild(countLabel);
                    cell.title = `${dayNumber} ${monthNames[startDate.getMonth()]} ${startDate.getFullYear()} · ${describeNotesCount(count)}`;
                    notesHeatmapGridEl.appendChild(cell);
                });

                if (maxCount <= 0) {
                    showStatusMessage(notesHeatmapMessageEl, 'No hay notas registradas en este mes.', 'info');
                }
            };

            refreshVisualizations = (reason = '', notes = cachedNotes) => {
                if (!Array.isArray(notes)) notes = cachedNotes;
                try {
                    renderMonthlyComparisonChart(notes);
                } catch (error) {
                    console.error('Error al actualizar el gráfico mensual.', error);
                    showStatusMessage(monthlyComparisonMessageEl, 'No fue posible actualizar el gráfico mensual.', 'error');
                }

                try {
                    const reference = heatmapReferenceDate instanceof Date ? heatmapReferenceDate : new Date();
                    renderNotesHeatmap(notes, reference);
                } catch (error) {
                    console.error('Error al actualizar el mapa de calor.', error);
                    showStatusMessage(notesHeatmapMessageEl, 'No fue posible actualizar el mapa de calor.', 'error');
                }
            };

            const handleMonthNavigation = (delta) => {
                const baseDate = heatmapReferenceDate instanceof Date && !Number.isNaN(heatmapReferenceDate.getTime())
                    ? new Date(heatmapReferenceDate)
                    : getStartOfMonth(new Date());
                baseDate.setMonth(baseDate.getMonth() + delta);
                heatmapReferenceDate = getStartOfMonth(baseDate);
                refreshVisualizations('month-navigation');
            };

            if (notesHeatmapPrevBtn) {
                notesHeatmapPrevBtn.addEventListener('click', () => handleMonthNavigation(-1));
            }
            if (notesHeatmapNextBtn) {
                notesHeatmapNextBtn.addEventListener('click', () => handleMonthNavigation(1));
            }
            const loadStats = (db) => {
                try {
                    const transaction = db.transaction([NOTES_STORE, TAGS_STORE], 'readonly');
                    const notesRequest = transaction.objectStore(NOTES_STORE).getAll();
                    const tagsRequest = transaction.objectStore(TAGS_STORE).getAll();

                    Promise.all([requestToPromise(notesRequest), requestToPromise(tagsRequest)])
                        .then(([notesRaw, tagsRaw]) => {
                            const notes = Array.isArray(notesRaw) ? notesRaw.filter((note) => typeof note?.id === 'number') : [];
                            const tagsMap = new Map();
                            if (Array.isArray(tagsRaw)) {
                                tagsRaw.forEach((tag) => {
                                    if (tag?.name) {
                                        tagsMap.set(tag.name, tag);
                                    }
                                });
                            }

                            if (notes.length === 0) {
                                showEmptyState();
                                return;
                            }

                            updateOverview(notes, tagsMap);
                        })
                        .catch((error) => {
                            console.error('No se pudieron obtener los datos del usuario.', error);
                            showEmptyState();
                        });
                } catch (error) {
                    console.error('Error al iniciar la transacción de estadísticas.', error);
                    showEmptyState();
                }
            };

            resetStats();

            if (!window.indexedDB) {
                console.warn('IndexedDB no está disponible en este navegador.');
                showEmptyState();
                return;
            }

            const openRequest = indexedDB.open(DB_NAME, DB_VERSION);
            openRequest.onsuccess = (event) => {
                const db = event.target.result;
                loadStats(db);
            };
            openRequest.onerror = () => {
                console.error('No se pudo abrir la base de datos NotesDB.');
                showEmptyState();
            };
            openRequest.onblocked = () => {
                console.warn('La base de datos está en uso por otra pestaña.');
            };
        });

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .then((registration) => {
                        console.log('ServiceWorker registration successful with scope: ', registration.scope);
                    })
                    .catch((error) => {
                        console.log('ServiceWorker registration failed: ', error);
                    });
            });
        }
    </script>
</body>
</html>
