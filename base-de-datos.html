<!DOCTYPE html>
<html lang="es" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplicación de Notas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .notes-container::-webkit-scrollbar {
            width: 8px;
        }
        .notes-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .notes-container::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        .notes-container::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 flex items-center justify-center min-h-screen font-sans p-4">

    <main class="bg-white rounded-2xl shadow-2xl p-6 md:p-8 w-full max-w-2xl flex flex-col gap-6">
        <header>
            <h1 class="text-3xl md:text-4xl font-bold text-center text-slate-900">Mis Notas</h1>
            <p class="text-center text-slate-500 mt-1">Tus notas se guardan de forma segura y remota.</p>
        </header>

        <form id="note-form" class="flex flex-col gap-4">
            <textarea 
                id="note-content"
                rows="4" 
                placeholder="Escribe tu nueva nota aquí..."
                class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-shadow resize-none"
            ></textarea>
            <button 
                type="submit"
                class="w-full bg-blue-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-transform transform active:scale-95 disabled:bg-slate-400 disabled:cursor-not-allowed"
            >
                Guardar Nota
            </button>
        </form>

        <div id="loader" class="text-center py-4">
            <svg class="animate-spin h-8 w-8 text-blue-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="mt-2 text-slate-500">Cargando notas...</p>
        </div>

        <section id="notes-section">
            <h2 class="text-2xl font-bold border-b pb-2 mb-4 text-slate-700">Notas Guardadas</h2>
            <div id="notes-container" class="space-y-4 max-h-96 overflow-y-auto pr-2 notes-container">
                <!-- Notes will be dynamically inserted here -->
            </div>
             <p id="no-notes-message" class="text-center text-slate-500 py-8 hidden">Aún no tienes notas. ¡Crea una!</p>
        </section>
    </main>

    <script type="module">
        import { createClient } from "https://esm.sh/@libsql/client@0.7.0";

        const TURSO_CONFIG = {
            url: "https://base-de-datos-app-notas-vercel-icfg-dpjxwkrjz0afamis8zhyhcmm.aws-us-east-1.turso.io",
            authToken: "eyJhbGciOiJFZERTQSIsInR5cCI6IkpXVCJ9.eyJhIjoicnciLCJpYXQiOjE3NTk2ODUyNjIsImlkIjoiZjIwMzk0NmUtOTIxYi00NWY1LWExYzctYjkyYTdkY2I1NGQxIiwicmlkIjoiNDNlZGRlZTUtNmUzZC00MjE2LThkNjgtN2M0Zjg4NjgyOThjIn0.YoLKiJy3hXsnaW9Zgmmr5pNn1hzjfZ0iZc6Pkj8sAAc9vtwt4R_8HmBA9PhsncOS5DnJdaxcpsV72CWycjvXAA",
        };

        const noteForm = document.getElementById('note-form');
        const noteContentInput = document.getElementById('note-content');
        const notesContainer = document.getElementById('notes-container');
        const loader = document.getElementById('loader');
        const noNotesMessage = document.getElementById('no-notes-message');
        const saveButton = noteForm.querySelector('button');

        let dbClient;

        async function setupDatabase() {
            try {
                await dbClient.execute(`
                    CREATE TABLE IF NOT EXISTS notes (
                        id INTEGER PRIMARY KEY AUTOINCREMENT,
                        content TEXT NOT NULL,
                        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
                    );
                `);
                console.log("Database table is ready.");
            } catch (error) {
                console.error("Failed to set up database:", error);
                alert("Error al configurar la base de datos. Revisa la consola para más detalles.");
            }
        }

        async function loadNotes() {
            loader.style.display = 'block';
            noNotesMessage.classList.add('hidden');
            notesContainer.innerHTML = '';
            
            try {
                console.log("Cargando notas...");
                const rs = await dbClient.execute("SELECT id, content, created_at FROM notes ORDER BY created_at DESC");
                console.log("Respuesta de la base de datos:", rs);
                
                // Verificar la estructura de la respuesta
                if (!rs || !rs.rows) {
                    console.error("Estructura de respuesta inesperada:", rs);
                    throw new Error("Estructura de respuesta inesperada de la base de datos");
                }
                
                if (rs.rows.length === 0) {
                    noNotesMessage.classList.remove('hidden');
                    console.log("No hay notas en la base de datos");
                } else {
                    console.log(`Se encontraron ${rs.rows.length} notas`);
                    rs.rows.forEach(row => {
                        console.log("Procesando nota:", row);
                        const noteElement = createNoteElement(row);
                        notesContainer.appendChild(noteElement);
                    });
                }
            } catch (error) {
                console.error("Failed to load notes:", error);
                // Mostrar error más específico en la UI
                const errorElement = document.createElement('div');
                errorElement.className = "bg-red-50 p-4 rounded-lg border border-red-200 text-red-700";
                errorElement.innerHTML = `
                    <p class="font-semibold">Error al cargar las notas</p>
                    <p class="text-sm mt-1">${error.message}</p>
                `;
                notesContainer.appendChild(errorElement);
            } finally {
                loader.style.display = 'none';
            }
        }

        async function addNote(content) {
            if (!content.trim()) return;
            
            saveButton.disabled = true;
            saveButton.textContent = 'Guardando...';

            try {
                await dbClient.execute({
                    sql: "INSERT INTO notes (content) VALUES (:content)",
                    args: { content }
                });
                noteContentInput.value = '';
                await loadNotes();
            } catch (error) {
                console.error("Failed to add note:", error);
                alert("No se pudo guardar la nota. Revisa la consola.");
            } finally {
                saveButton.disabled = false;
                saveButton.textContent = 'Guardar Nota';
            }
        }

        async function deleteNote(id) {
            try {
                await dbClient.execute({
                    sql: "DELETE FROM notes WHERE id = :id",
                    args: { id }
                });
                const noteToRemove = document.querySelector(`[data-note-id='${id}']`);
                if (noteToRemove) {
                    noteToRemove.classList.add('opacity-0', 'scale-90');
                    setTimeout(() => {
                        noteToRemove.remove();
                        if (notesContainer.children.length === 0) {
                             noNotesMessage.classList.remove('hidden');
                        }
                    }, 300);
                }
            } catch (error) {
                console.error("Failed to delete note:", error);
                alert("No se pudo eliminar la nota. Revisa la consola.");
            }
        }
        
        function createNoteElement(noteData) {
            console.log("Creando elemento para nota:", noteData);
            
            const div = document.createElement('div');
            div.className = "bg-slate-50 p-4 rounded-lg border border-slate-200 flex justify-between items-start gap-4 transition-all duration-300";
            div.dataset.noteId = noteData.id;

            const contentDiv = document.createElement('div');
            
            const p = document.createElement('p');
            p.textContent = noteData.content;
            p.className = "text-slate-800 whitespace-pre-wrap break-words";

            const time = document.createElement('time');
            
            // Manejo más robusto de fechas
            let date;
            try {
                if (noteData.created_at) {
                    // Intentar diferentes formatos de fecha
                    if (typeof noteData.created_at === 'string') {
                        // Si es string, intentar parsear
                        let dateString = noteData.created_at;
                        
                        // Si tiene espacio, reemplazar por T para formato ISO
                        if (dateString.includes(' ')) {
                            dateString = dateString.replace(' ', 'T');
                        }
                        
                        // Si no termina con Z, agregar Z para indicar UTC
                        if (!dateString.endsWith('Z')) {
                            dateString += 'Z';
                        }
                        
                        date = new Date(dateString);
                    } else if (noteData.created_at instanceof Date) {
                        date = noteData.created_at;
                    }
                }
                
                // Si no se pudo parsear la fecha, usar fecha actual
                if (!date || isNaN(date.getTime())) {
                    date = new Date();
                }
                
                time.textContent = date.toLocaleString('es-ES');
            } catch (dateError) {
                console.error("Error procesando fecha:", dateError);
                time.textContent = "Fecha no disponible";
            }
            
            time.className = "text-xs text-slate-400 mt-2 block";
            
            contentDiv.appendChild(p);
            contentDiv.appendChild(time);
            
            const deleteButton = document.createElement('button');
            deleteButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-slate-400 hover:text-red-500 transition-colors"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>`;
            deleteButton.className = "flex-shrink-0 p-1";
            deleteButton.setAttribute('aria-label', 'Eliminar nota');
            deleteButton.onclick = () => deleteNote(noteData.id);

            div.appendChild(contentDiv);
            div.appendChild(deleteButton);

            return div;
        }

        async function main() {
            try {
                dbClient = createClient(TURSO_CONFIG);
                await setupDatabase();
                await loadNotes();
            } catch(e) {
                 console.error("Failed to initialize Turso client:", e);
                 loader.innerHTML = `<p class="text-red-500">Error de conexión con la base de datos. Revisa la consola.</p>`
                 return;
            }

            noteForm.addEventListener('submit', (e) => {
                e.preventDefault();
                addNote(noteContentInput.value);
            });
        }

        main();
    </script>
</body>
</html>